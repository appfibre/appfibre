!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@appfibre/webapp")):"function"==typeof define&&define.amd?define(["exports","@appfibre/webapp"],t):t((e=e||self).Designer={},e.webapp)}(this,function(e,d){"use strict";var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function r(e,t){function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function o(e){return r(t,n=e.services.UI.Component),t.prototype.componentDidMount=function(){e.services.events.subscribe(l(),this.onSelect)},t.prototype.componentWillUnmount=function(){e.services.events.unsubscribe(l(),this.onSelect)},t.prototype.url_change=function(e){this.setState({url:e.target.value})},t.prototype.navigate_click=function(){e.services.events.publish(c({url:this.state.url}))},t.prototype.render=function(){return n.prototype.render.call(this,["div",{},[["div",{},[["input",{type:"text",style:{width:"calc(100% - 45px)",background:"transparent"},value:this.state.url,onChange:this.url_change}],["button",{style:{float:"right"},onClick:this.navigate_click},"GO"]]],["label",{},this.state.selectedContext&&this.state.selectedContext.control?this.state.selectedContext.control.url+" "+this.state.selectedContext.control.method:"(none)"],this.state.selectedContext&&this.state.selectedContext.control&&this.state.selectedContext.canEdit?["button",{},"Edit"]:["span",{},"------"]]])},t.prototype.onSelect=function(e){this.setState({selectedContext:e.data,source:e.data.control.url})},t;function t(e){var t=n.call(this,e)||this;return t.state={selectedContext:null,source:null,url:"./pages/latest/index.json"},t.url_change=t.url_change.bind(t),t.navigate_click=t.navigate_click.bind(t),t.onSelect=t.onSelect.bind(t),t}var n}function a(p){return r(e,a=p.services.UI.Component),e.prototype.distributeSpace=function(e,t){var n=0,i=e.reduce(function(e,t){return t.size||n++,t.size?e-t.size:e},t-(e.length-1));return e.map(function(e){return s({},e,{ratio:(e.size||i/n)/t})})},e.prototype.window_mousemove=function(e){var n=this;if(this.state.resize){var i=this.state.resize.splitter,o=(this.state.vertical?e.clientY:e.clientX)-this.state.resize.start,t=this.state.panels[i],s=this.state.panels[i+1],r=this.state.resize.prev,a=this.state.resize.next,c=this.state.resize.prev_ratio,l=this.state.resize.next_ratio;(!t.max||t.max>=r+o)&&(!t.min||t.min<=r+o)&&(!s.min||s.min<=a-o)&&(!s.max||s.max>=a-o)&&this.setState({panels:this.state.panels.map(function(e,t){return t!==i&&t!==i+1||(e.size&&p.info.browser!==d.types.browserType.Safari?e.size=t===i?r+o:a-o:e.ratio=(t===i?c:l)+(t===i?1:-1)*(o/(n.state.vertical?screen.availHeight:screen.availWidth))),e})})}},e.prototype.splitter_mousedown=function(e,t){if(e.target){var n=e.target,i=n.previousElementSibling,o=n.nextElementSibling,s=this.state.vertical;i&&o&&this.setState({resize:{splitter:t,prev:i[s?"clientHeight":"clientWidth"],next:o[s?"clientHeight":"clientWidth"],start:s?e.clientY:e.clientX,prev_ratio:this.state.panels[t].ratio,next_ratio:this.state.panels[t+1].ratio}})}window.addEventListener("mouseup",this.window_mouseup),window.addEventListener("mousemove",this.window_mousemove)},e.prototype.window_mouseup=function(e){window.removeEventListener("mouseup",this.window_mouseup),window.removeEventListener("mousemove",this.window_mousemove),this.setState({resize:void 0})},e.prototype.render=function(){var i=this,o=[],s=p.info.browser,r={margin:0,padding:0,width:"1px",cursor:this.state.vertical?"row-resize":"col-resize"};return r[this.state.vertical?"width":"height"]="100%",this.state.vertical||(r.display="inline-block",r.verticalAlign="top"),this.state.panels.forEach(function(e,t){0<t&&o.push(["div",{style:r,onMouseDown:function(e){return i.splitter_mousedown.call(i,e,t-1)}}]);var n={border:"0px solid grey",margin:0,padding:0};n[i.state.vertical?"width":"height"]="100%",n[i.state.vertical?"height":"width"]=e.size&&s!==d.types.browserType.Safari?e.size+"px":100*e.ratio+"%",e.size||(n.flexGrow=1),i.state.resize&&(n.pointerEvents="none"),i.state.vertical||(n.display="inline-block",n.verticalAlign="top"),o.push(["div",{style:n},[e.content]])}),a.prototype.render.call(this,["div",{style:{display:"flex",flexDirection:this.state.direction,margin:0,padding:0,height:"100%",width:"100%",overflow:"hidden"}},o])},e;function e(n){var e=a.call(this,n)||this,t=(n.children||[]).map(function(e,t){return n.defaults&&t<n.defaults.length?s({},n.defaults[t],{content:e}):{content:e}}),i="column"===n.direction||"column-reverse"===n.direction;return e.state={direction:n.direction||"row",vertical:i,panels:e.distributeSpace(t,i?screen.availHeight:screen.availWidth)},e.window_mouseup=e.window_mouseup.bind(e),e.window_mousemove=e.window_mousemove.bind(e),e.splitter_mousedown=e.splitter_mousedown.bind(e),e}var a}var s=function(){return(s=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},c=function(e){return{type:"Designer.Load",data:e}},l=function(e){return{type:"Designer.Intercept.Select",data:e}},t=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");t.appendChild(n),n.type="text/css",n.appendChild(document.createTextNode(".flex {\ndisplay: -webkit-box;\ndisplay: -moz-box;\ndisplay: box;\ndisplay: -moz-flex;\ndisplay: flex;\n}"));function p(i){return r(e,n=i.services.UI.Component),e.prototype.componentDidMount=function(){window.addEventListener("message",this.onMessage),window.onclick=function(){parent.postMessage({eventType:"select",correlationId:Date.now().toString()},location.href)}},e.prototype.componentWillUnmount=function(){window.removeEventListener("message",this.onMessage)},e.prototype.reconstruct=function(e){return e[1]||(e[1]={}),e[1].style||(e[1].style={}),e[1].style.border||e[1].style.padding||e[1].onMouseEnter||e[1].onMouseLeave||(e[1].style.padding=this.state.focus||this.state.selected?"1px":"2px",this.state.editMode&&(e[1].style.background="lightblue"),this.state.selected?e[1].style.border="1px solid black":this.state.focus&&(e[1].style.border="1px dashed grey"),e[1].onMouseEnter=this.mouseEnter,e[1].onMouseLeave=this.mouseLeave,e[1].onClick=this.click),e},e.prototype.render=function(){return n.prototype.render.call(this,this.reconstruct(["div",{style:{display:""},key:0},this.props.children]))},e.prototype.mouseEnter=function(){this.setState({focus:!0})},e.prototype.mouseLeave=function(){this.setState({focus:!1})},e.prototype.click=function(e){e.stopPropagation();for(var t=window;t.parent!==t&&null!=window.parent;)t=t.parent;var n=Date.now().toString();i.services.events.publish({type:"Designer.Intercept.Select",correlationId:n,data:{editMode:this.state.editMode,canEdit:this.state.canEdit,control:{url:this.props.file,method:this.props.method}}},t),this.setState({selected:n})},e.prototype.onMessage=function(e){if(location.href.substr(0,e.origin.length)==e.origin&&"message"==e.type&&e.data&&this.state.selected==e.data.correlationId)switch(e.data.eventType){case"deselect":this.setState({selected:!1});break;case"edit":this.setState({editMode:e.data.editMode})}},e;function e(e){var t=n.call(this,e)||this;return t.state={focus:!1,selected:!1,editMode:null,canEdit:!0},t.onMessage=t.onMessage.bind(t),t.click=t.click.bind(t),t.mouseEnter=t.mouseEnter.bind(t),t.mouseLeave=t.mouseLeave.bind(t),t}var n}var u={Flex:function(e,t,n){return t.className="flex",[e,t,n]},FlexItem:function(e,t,n){return[e,t,n]},Grid:function(e,t,n){return[e,t,n]},GridItem:function(e,t,n){return[e,t,n]},TabContainer:function(e){return r(t,s=e.services.UI.Component),t.prototype.render=function(){var e=[],t=this.props.placement||"top",n="top"===t||"bottom"===t,i=[],o=this.props.selectedIndex||0;return"top"!==t&&"left"!==t||(i.push({size:20,min:20,max:20}),e.push(["div",null,"tabs"])),i.push({}),e.push(this.props.children&&this.props.children.length>o?this.props.children[o]:["div",{},"empty"]),"bottom"!==t&&"right"!==t||(i.push({size:20,min:20,max:20}),e.push(["div",null,"tabs"])),s.prototype.render.call(this,[a,{direction:n?"column":"row",defaults:i},e])},t;function t(e){return s.call(this,e)||this}var s},SplitContainer:a},h=window.parent===window?function(t){return r(e,n=t.services.UI.Component),e.prototype.componentWillMount=function(){window===window.parent&&t.services.events.subscribe({type:"Navigation.Redirect"},this.onRedirect),t.services.events.subscribe(c(),this.designer_Load)},e.prototype.componentWillUnmount=function(){window===window.parent&&t.services.events.unsubscribe({type:"Navigation.Redirect"},this.onRedirect),t.services.events.unsubscribe(c(),this.designer_Load)},e.prototype.designer_Load=function(e){this.iframe&&this.iframe.contentWindow&&t.services.events.publish(e,this.iframe.contentWindow)},e.prototype.componentDidMount=function(){document.body.style.margin="0px",document.body.style.height="100%"},e.prototype.navigateTo=function(e){this.setState({url:e})},e.prototype.onRedirect=function(e){},e.prototype.render=function(){var t=this;return n.prototype.render.call(this,["div",{style:{height:"100%",backgroundColor:"#EEE",backgroundImage:"linear-gradient(#DEDEDE, #EFEFEF)"}},[[u.SplitContainer,{direction:"column",defaults:[{size:120,min:120,max:120},{},{size:50,min:50,max:50}]},[[o,{},"top"],[u.SplitContainer,{direction:"row",defaults:[{size:350,min:100,max:500},{},{size:350,min:100,max:500}]},[[u.TabContainer,{placement:"bottom",tabs:["Tab1","Tab2","Tab3"]},[["div",{},"tab 1 content"]]],["iframe",{style:{width:"100%",height:"100%",background:"white"},src:location.href,ref:function(e){t.iframe=e}}],[u.TabContainer,{placement:"bottom",tabs:["Tab1","Tab2","Tab3"]},[["div",{},"tab 1 content"]]]]],["div",{},"bottom"]]]]])},e;function e(e){var t=n.call(this,e)||this;return t.state={src:e.src},t.navigateTo=t.navigateTo.bind(t),t.onRedirect=t.onRedirect.bind(t),t.designer_Load=t.designer_Load.bind(t),t}var n}:function(o){return o.services.transformer.settings.parsers&&(o.services.transformer.settings.parsers[".app"]=function(t,e,n){var i={};return Object.keys(t).forEach(function(e){return i[".app"==e?"main":e]=t[e]}),'[".App", {'+o.services.transformer._process(i,!0,!0,e,n)+"}]"}),o.services.processor.init=function(e){return"string"==typeof e.__esModule?[p,{file:e.__esModule},[e.default]]:e.default},r(e,n=o.services.UI.Component),e.prototype.componentWillMount=function(){o.services.events.subscribe(c(),this.designer_Load)},e.prototype.componentWillUnmount=function(){o.services.events.unsubscribe(c(),this.designer_Load)},e.prototype.designer_Load=function(e){var t=this;o.services.moduleSystem.import(e.data.url).then(function(e){t.setState({content:e})},alert)},e.prototype.render=function(){return n.prototype.render.call(this,this.state.content)},e;function e(e){var t=n.call(this,e)||this;return t.props=e,t.state={content:o.main},t.designer_Load=t.designer_Load.bind(t),t}var n};e.Designer=h,Object.defineProperty(e,"__esModule",{value:!0})});
